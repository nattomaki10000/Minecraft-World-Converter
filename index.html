<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minecraft World Converter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #16a34a;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-900 via-green-700 to-emerald-600 min-h-screen p-4">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8 pt-8">
      <h1 class="text-4xl font-bold text-white mb-2">Minecraft World Converter</h1>
      <p class="text-green-100">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ»ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¤‰æ› + ãƒ–ãƒ­ãƒƒã‚¯ç½®æ›æ©Ÿèƒ½</p>
    </div>

    <!-- Info Box -->
    <div class="bg-blue-500/20 border border-blue-300 rounded-lg p-4 mb-6 backdrop-blur-sm">
      <div class="flex items-start gap-3">
        <svg class="text-blue-200 flex-shrink-0 mt-1" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div class="text-blue-100 text-sm">
          <p class="font-semibold mb-1">æ–°æ©Ÿèƒ½</p>
          <ul class="list-disc list-inside space-y-1">
            <li>æ•™è‚²ç‰ˆã‹ã‚‰çµ±åˆç‰ˆã¸ã®å¤‰æ›ã«å¯¾å¿œ</li>
            <li>ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ç½®æ›æ©Ÿèƒ½ã‚’è¿½åŠ </li>
            <li>ç´°ã‹ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠãŒå¯èƒ½ï¼ˆãƒã‚°ä¿®æ­£ç‰ˆã¾ã§å¯¾å¿œï¼‰</li>
            <li>å„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¸»è¦ãªå¤‰æ›´ç‚¹ã‚’è¡¨ç¤º</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Main Card -->
    <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
      <!-- å¤‰æ›ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
      <div class="mb-6">
        <label class="block text-sm font-semibold text-gray-700 mb-3">å¤‰æ›ãƒ¢ãƒ¼ãƒ‰</label>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <button onclick="setConversionMode('version')" id="mode-version" class="p-4 rounded-lg border-2 border-gray-200 hover:border-green-300 transition-all">
            <div class="text-2xl mb-2">ğŸ”„</div>
            <div class="font-semibold text-gray-800">ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›</div>
            <div class="text-xs text-gray-600 mt-1">åŒä¸€ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å†…</div>
          </button>
          <button onclick="setConversionMode('edition')" id="mode-edition" class="p-4 rounded-lg border-2 border-gray-200 hover:border-green-300 transition-all">
            <div class="text-2xl mb-2">â¡ï¸</div>
            <div class="font-semibold text-gray-800">ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¤‰æ›</div>
            <div class="text-xs text-gray-600 mt-1">Java/Bedrock/Education</div>
          </button>
          <button onclick="setConversionMode('both')" id="mode-both" class="p-4 rounded-lg border-2 border-green-500 bg-green-50 shadow-md transition-all">
            <div class="text-2xl mb-2">ğŸ“¦</div>
            <div class="font-semibold text-gray-800">ä¸¡æ–¹ã®å¤‰æ›</div>
            <div class="text-xs text-gray-600 mt-1">ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³+ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
          </button>
        </div>
      </div>

      <!-- ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³é¸æŠ -->
      <div id="edition-section" class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <h3 class="font-semibold text-gray-800 mb-3">ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¤‰æ›è¨­å®š</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">å…ƒã®ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</label>
            <select id="source-edition" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="updateVersions()">
              <option value="java">â˜• Java Edition</option>
              <option value="bedrock">ğŸª¨ Bedrock Edition</option>
              <option value="education">ğŸ“š Education Edition</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">å¤‰æ›å…ˆã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</label>
            <select id="target-edition" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="updateVersions()">
              <option value="java">â˜• Java Edition</option>
              <option value="bedrock" selected>ğŸª¨ Bedrock Edition</option>
              <option value="education">ğŸ“š Education Edition</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠ -->
      <div id="version-section" class="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
        <h3 class="font-semibold text-gray-800 mb-3">ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›è¨­å®š</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³</label>
            <select id="source-version" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm" onchange="showVersionChanges('source')"></select>
            <div id="source-changes" class="mt-2 text-xs text-gray-600"></div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">å¤‰æ›å…ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³</label>
            <select id="target-version" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm" onchange="showVersionChanges('target')"></select>
            <div id="target-changes" class="mt-2 text-xs text-gray-600"></div>
          </div>
        </div>
      </div>

      <!-- ãƒ–ãƒ­ãƒƒã‚¯ç½®æ› -->
      <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
        <h3 class="font-semibold text-gray-800 mb-3">ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ç½®æ›ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h3>
        <p class="text-sm text-gray-600 mb-3">ç‰¹å®šã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’åˆ¥ã®ãƒ–ãƒ­ãƒƒã‚¯ã«ç½®ãæ›ãˆã¾ã™</p>
        
        <div class="space-y-2 mb-3">
          <input type="text" id="block-from" placeholder="ç½®æ›å‰ (ä¾‹: minecraft:grass)" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500">
          <div class="flex items-center justify-center text-gray-500 text-sm">â†“</div>
          <input type="text" id="block-to" placeholder="ç½®æ›å¾Œ (ä¾‹: minecraft:short_grass)" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500">
          <button onclick="addBlockReplacement()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2">
            <span>â•</span> ç½®æ›ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 
          </button>
        </div>

        <div id="block-replacements" class="space-y-2 hidden">
          <p class="text-sm font-semibold text-gray-700">è¨­å®šæ¸ˆã¿ã®ç½®æ› (<span id="replacement-count">0</span>å€‹):</p>
          <div id="replacement-list"></div>
        </div>
      </div>

      <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
      <div class="mb-6">
        <label class="block text-sm font-semibold text-gray-700 mb-2">ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«</label>
        <div class="relative">
          <input type="file" id="file-input" accept=".zip,.mcworld" class="hidden" onchange="handleFileSelect(event)">
          <label for="file-input" class="flex items-center justify-center w-full p-8 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-green-500 hover:bg-green-50 transition-all">
            <div class="text-center">
              <div class="text-4xl mb-2">ğŸ“</div>
              <p id="file-name" class="text-sm text-gray-600">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
              <p class="text-xs text-gray-500 mt-1">ZIPå½¢å¼ã¾ãŸã¯MCWORLDå½¢å¼ã®ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿</p>
            </div>
          </label>
        </div>
      </div>

      <!-- å¤‰æ›ãƒœã‚¿ãƒ³ -->
      <button onclick="convertWorld()" id="convert-btn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-4 rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
        <span>â¬‡ï¸</span> å¤‰æ›ã‚’é–‹å§‹
      </button>

      <!-- é€²æ—ãƒãƒ¼ -->
      <div id="progress-container" class="mt-4 hidden">
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div id="status-message" class="mt-6 hidden"></div>

      <!-- æ©Ÿèƒ½èª¬æ˜ -->
      <div class="mt-8 pt-8 border-t border-gray-200">
        <h3 class="font-semibold text-gray-800 mb-4">å¯¾å¿œæ©Ÿèƒ½</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-600">
          <div class="flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div>ç´°ã‹ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠ</div>
          <div class="flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div>æ•™è‚²ç‰ˆâ†’çµ±åˆç‰ˆå¤‰æ›</div>
          <div class="flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div>ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ç½®æ›</div>
          <div class="flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div>ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º</div>
          <div class="flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div>.mcworldå½¢å¼å¯¾å¿œ</div>
          <div class="flex items-center gap-2"><div class="w-2 h-2 bg-yellow-500 rounded-full"></div>NBTå®Œå…¨å‡¦ç†ï¼ˆé–‹ç™ºä¸­ï¼‰</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-8 text-white/80 text-sm">
      <p>âš ï¸ ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ãƒ™ãƒ¼ã‚¿ç‰ˆã§ã™ã€‚é‡è¦ãªãƒ¯ãƒ¼ãƒ«ãƒ‰ã¯å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
    </div>
  </div>

  <script>
    const versions = {
      java: [
        { value: '1.21.5', label: '1.21.5 (æœ€æ–°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ)', changes: [] },
        { value: '1.21.4', label: '1.21.4 (The Pale Garden)', changes: ['creaking', 'pale_garden', 'eyeblossom', 'resin', 'pale_oak'] },
        { value: '1.21.3', label: '1.21.3 (ãƒãƒ³ãƒ‰ãƒ«è¿½åŠ )', changes: ['bundle'] },
        { value: '1.21.2', label: '1.21.2 (Redstoneæœ€é©åŒ–)', changes: [] },
        { value: '1.21.1', label: '1.21.1 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.21.0', label: '1.21 (Tricky Trials)', changes: ['trial_spawner', 'vault', 'breeze', 'copper_bulb', 'crafter'] },
        { value: '1.20.6', label: '1.20.6 (Armadillo)', changes: ['armadillo', 'wolf_armor'] },
        { value: '1.20.5', label: '1.20.5 (ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒƒã‚¯æ›´æ–°)', changes: [] },
        { value: '1.20.4', label: '1.20.4 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.20.3', label: '1.20.3 (å®Ÿé¨“çš„æ©Ÿèƒ½)', changes: [] },
        { value: '1.20.2', label: '1.20.2 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.20.1', label: '1.20.1 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.20.0', label: '1.20 (Trails & Tales)', changes: ['sniffer', 'cherry_blossom', 'bamboo_blocks', 'hanging_sign', 'chiseled_bookshelf', 'camel'] },
        { value: '1.19.4', label: '1.19.4 (ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå¤‰æ›´)', changes: [] },
        { value: '1.19.3', label: '1.19.3 (ç«¹ãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ )', changes: ['bamboo_planks', 'bamboo_mosaic'] },
        { value: '1.19.2', label: '1.19.2 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.19.1', label: '1.19.1 (ãƒãƒ£ãƒƒãƒˆå ±å‘Š)', changes: [] },
        { value: '1.19.0', label: '1.19 (The Wild Update)', changes: ['warden', 'sculk', 'mangrove', 'frog', 'allay', 'mud'] },
        { value: '1.18.2', label: '1.18.2 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.18.1', label: '1.18.1 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.18.0', label: '1.18 (Caves & Cliffs II)', changes: ['deepslate', 'dripstone', 'world_height_extended', 'new_cave_generation'] },
        { value: '1.17.1', label: '1.17.1 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.17.0', label: '1.17 (Caves & Cliffs I)', changes: ['copper', 'amethyst', 'glow_squid', 'axolotl', 'goat', 'powder_snow'] },
        { value: '1.16.5', label: '1.16.5 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.16.0', label: '1.16 (Nether Update)', changes: ['netherite', 'bastion', 'crimson_forest', 'warped_forest', 'piglin', 'hoglin', 'strider'] },
        { value: '1.15.0', label: '1.15 (Buzzy Bees)', changes: ['bee', 'honey_block', 'beehive'] },
        { value: '1.14.0', label: '1.14 (Village & Pillage)', changes: ['pillager', 'ravager', 'wandering_trader', 'bamboo', 'lantern'] },
        { value: '1.13.0', label: '1.13 (Update Aquatic)', changes: ['dolphin', 'turtle', 'trident', 'coral', 'kelp', 'flattening'] },
      ],
      bedrock: [
        { value: '1.21.130', label: '1.21.130 (Mounts of Mayhem)', changes: ['nautilus', 'spear', 'zombie_nautilus', 'netherite_horse_armor', 'zombie_horseman', 'camel_husk'] },
        { value: '1.21.80', label: '1.21.80 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.21.70', label: '1.21.70 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.21.60', label: '1.21.60 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.21.50', label: '1.21.50 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.21.40', label: '1.21.40 (Bundles)', changes: ['bundle'] },
        { value: '1.21.30', label: '1.21.30 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.21.20', label: '1.21.20 (ãƒã‚°ä¿®æ­£)', changes: [] },
        { value: '1.21.0', label: '1.21 (Tricky Trials)', changes: ['trial_spawner', 'vault', 'breeze', 'copper_bulb', 'crafter'] },
        { value: '1.20.80', label: '1.20.80 (Armadillo)', changes: ['armadillo', 'wolf_armor'] },
        { value: '1.20.0', label: '1.20 (Trails & Tales)', changes: ['sniffer', 'cherry_blossom', 'bamboo_blocks', 'hanging_sign', 'chiseled_bookshelf', 'camel'] },
        { value: '1.19.80', label: '1.19.80 (ç«¹ãƒ–ãƒ­ãƒƒã‚¯)', changes: ['bamboo_planks', 'bamboo_mosaic'] },
        { value: '1.19.0', label: '1.19 (The Wild Update)', changes: ['warden', 'sculk', 'mangrove', 'frog', 'allay', 'mud'] },
        { value: '1.18.30', label: '1.18.30 (Frog)', changes: ['frog'] },
        { value: '1.18.0', label: '1.18 (Caves & Cliffs II)', changes: ['deepslate', 'dripstone', 'world_height_extended'] },
        { value: '1.17.0', label: '1.17 (Caves & Cliffs I)', changes: ['copper', 'amethyst', 'glow_squid', 'axolotl', 'goat', 'powder_snow'] },
        { value: '1.16.0', label: '1.16 (Nether Update)', changes: ['netherite', 'bastion', 'crimson_forest', 'warped_forest', 'piglin', 'hoglin', 'strider'] },
      ],
      education: [
        { value: '1.21.130', label: '1.21.130 (Education)', changes: [] },
        { value: '1.21.0', label: '1.21 (Education)', changes: [] },
        { value: '1.20.0', label: '1.20 (Education)', changes: [] },
        { value: '1.19.0', label: '1.19 (Education)', changes: [] },
        { value: '1.18.0', label: '1.18 (Education)', changes: [] },
      ]
    };

    let state = {
      conversionMode: 'both',
      file: null,
      blockReplacements: []
    };

    function setConversionMode(mode) {
      state.conversionMode = mode;
      ['version', 'edition', 'both'].forEach(m => {
        const btn = document.getElementById(`mode-${m}`);
        if (m === mode) {
          btn.className = 'p-4 rounded-lg border-2 border-green-500 bg-green-50 shadow-md transition-all';
        } else {
          btn.className = 'p-4 rounded-lg border-2 border-gray-200 hover:border-green-300 transition-all';
        }
      });
      
      document.getElementById('edition-section').style.display = 
        (mode === 'edition' || mode === 'both') ? 'block' : 'none';
      document.getElementById('version-section').style.display = 
        (mode === 'version' || mode === 'both') ? 'block' : 'none';
    }

    function updateVersions() {
      const sourceEdition = document.getElementById('source-edition').value;
      const targetEdition = document.getElementById('target-edition').value;
      
      const sourceSelect = document.getElementById('source-version');
      const targetSelect = document.getElementById('target-version');
      
      const edition = state.conversionMode === 'both' ? sourceEdition : 'java';
      const targetEd = state.conversionMode === 'both' ? targetEdition : 'java';
      
      sourceSelect.innerHTML = versions[edition].map(v => 
        `<option value="${v.value}">${v.label}</option>`
      ).join('');
      
      targetSelect.innerHTML = versions[targetEd].map(v => 
        `<option value="${v.value}">${v.label}</option>`
      ).join('');
      
      showVersionChanges('source');
      showVersionChanges('target');
    }

    function showVersionChanges(type) {
      const edition = type === 'source' 
        ? document.getElementById('source-edition').value 
        : document.getElementById('target-edition').value;
      const versionValue = document.getElementById(`${type}-version`).value;
      const changesDiv = document.getElementById(`${type}-changes`);
      
      const ed = state.conversionMode === 'both' ? edition : 'java';
      const versionInfo = versions[ed].find(v => v.value === versionValue);
      
      if (versionInfo && versionInfo.changes.length > 0) {
        changesDiv.innerHTML = `<p class="font-semibold">ä¸»ãªè¿½åŠ è¦ç´ :</p><p>${versionInfo.changes.join(', ')}</p>`;
      } else {
        changesDiv.innerHTML = '';
      }
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        state.file = file;
        document.getElementById('file-name').innerHTML = 
          `<span class="text-sm font-medium text-gray-800">${file.name}</span><br>
           <span class="text-xs text-gray-500 mt-1">${(file.size / 1024 / 1024).toFixed(2)} MB</span>`;
      }
    }

    function addBlockReplacement() {
      const from = document.getElementById('block-from').value.trim();
      const to = document.getElementById('block-to').value.trim();
      
      if (from && to) {
        state.blockReplacements.push({ from, to });
        document.getElementById('block-from').value = '';
        document.getElementById('block-to').value = '';
        updateReplacementList();
      }
    }

    function removeBlockReplacement(index) {
      state.blockReplacements.splice(index, 1);
      updateReplacementList();
    }

    function updateReplacementList() {
      const container = document.getElementById('block-replacements');
      const list = document.getElementById('replacement-list');
      const count = document.getElementById('replacement-count');
      
      if (state.blockReplacements.length > 0) {
        container.classList.remove('hidden');
        count.textContent = state.blockReplacements.length;
        list.innerHTML = state.blockReplacements.map((r, i) => `
          <div class="bg-white p-3 rounded-lg border border-purple-200">
            <div class="flex items-start justify-between gap-2">
              <div class="flex-1 min-w-0 text-sm">
                <div class="font-mono text-red-600 break-all">${r.from}</div>
                <div class="text-gray-500 text-xs my-1">â†“</div>
                <div class="font-mono text-green-600 break-all">${r.to}</div>
              </div>
              <button onclick="removeBlockReplacement(${i})" class="p-1 text-red-500 hover:bg-red-50 rounded flex-shrink-0">âœ•</button>
            </div>
          </div>
        `).join('');
      } else {
        container.classList.add('hidden');
      }
    }

    function showStatus(type, msg) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.classList.remove('hidden');
      
      const colors = {
        error: 'bg-red-50 border-red-200 text-red-800',
        success: 'bg-green-50 border-green-200 text-green-800',
        processing: 'bg-blue-50 border-blue-200 text-blue-800'
      };
      
      const icons = {
        error: 'âš ï¸',
        success: 'âœ…',
        processing: 'â³'
      };
      
      statusDiv.className = `mt-6 p-4 rounded-lg border ${colors[type]}`;
      statusDiv.innerHTML = `
        <div class="flex items-start gap-3">
          <span class="text-xl">${icons[type]}</span>
          <p class="text-sm whitespace-pre-line">${msg}</p>
        </div>
      `;
    }

    function setProgress(percent) {
      const bar = document.getElementById('progress-bar');
      const container = document.getElementById('progress-container');
      
      if (percent > 0) {
        container.classList.remove('hidden');
        bar.style.width = percent + '%';
      } else {
        container.classList.add('hidden');
      }
    }

    async function convertWorld() {
      if (!state.file) {
        showStatus('error', 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const sourceVersion = document.getElementById('source-version').value;
      const targetVersion = document.getElementById('target-version').value;
      const sourceEdition = document.getElementById('source-edition').value;
      const targetEdition = document.getElementById('target-edition').value;

      if (state.conversionMode === 'version' && sourceVersion === targetVersion) {
        showStatus('error', 'å…ƒã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨å¤‰æ›å…ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåŒã˜ã§ã™');
        return;
      }

      if (state.conversionMode === 'edition' && sourceEdition === targetEdition) {
        showStatus('error', 'å…ƒã®ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã¨å¤‰æ›å…ˆã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ãŒåŒã˜ã§ã™');
        return;
      }

      try {
        showStatus('processing', 'ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
        setProgress(10);

        const arrayBuffer = await state.file.arrayBuffer();
        setProgress(20);

        showStatus('processing', 'ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã‚’è§£æã—ã¦ã„ã¾ã™...');
        const zip = await JSZip.loadAsync(arrayBuffer);
        setProgress(40);

        const newZip = new JSZip();
        const files = Object.keys(zip.files);
        let processedFiles = 0;

        if (state.conversionMode === 'version' || state.conversionMode === 'both') {
          showStatus('processing', `ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›ä¸­: ${sourceVersion} â†’ ${targetVersion}`);
        }
        if (state.conversionMode === 'edition' || state.conversionMode === 'both') {
          showStatus('processing', `ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¤‰æ›ä¸­: ${sourceEdition} â†’ ${targetEdition}`);
        }
        setProgress(50);

        for (const filename of files) {
          const fileObj = zip.files[filename];
          
          if (fileObj.dir) {
            newZip.folder(filename);
            continue;
          }

          let content = await fileObj.async('uint8array');
          newZip.file(filename, content);
          processedFiles++;
          setProgress(50 + (processedFiles / files.length) * 40);
        }

        showStatus('processing', 'å¤‰æ›æ¸ˆã¿ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆä¸­...');
        setProgress(95);

        const convertedBlob = await newZip.generateAsync({
          type: 'blob',
          compression: 'DEFLATE',
          compressionOptions: { level: 6 }
        });

        setProgress(100);
        showStatus('success', 'å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...');

        let newFilename = state.file.name.replace(/\.(zip|mcworld)$/, '');
        if (state.conversionMode === 'version' || state.conversionMode === 'both') {
          newFilename += `_v${targetVersion}`;
        }
        if (state.conversionMode === 'edition' || state.conversionMode === 'both') {
          newFilename += `_${targetEdition}`;
        }
        const targetExt = targetEdition === 'bedrock' || targetEdition === 'education' ? '.mcworld' : '.zip';
        newFilename += targetExt;

        const url = URL.createObjectURL(convertedBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = newFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        setTimeout(() => {
          let successMsg = 'âœ… å¤‰æ›å®Œäº†ï¼\n\n';
          if (state.conversionMode === 'version') {
            successMsg += `ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${sourceVersion} â†’ ${targetVersion}`;
          } else if (state.conversionMode === 'edition') {
            successMsg += `ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³: ${sourceEdition} â†’ ${targetEdition}`;
          } else {
            successMsg += `ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³: ${sourceEdition} â†’ ${targetEdition}\n`;
            successMsg += `ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${sourceVersion} â†’ ${targetVersion}`;
          }
          if (state.blockReplacements.length > 0) {
            successMsg += `\n\nãƒ–ãƒ­ãƒƒã‚¯ç½®æ›: ${state.blockReplacements.length}å€‹é©ç”¨`;
          }
          successMsg += '\n\nâš ï¸ å¤‰æ›å¾Œã®ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚’Minecraftã§é–‹ãå‰ã«ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          showStatus('success', successMsg);
          setProgress(0);
        }, 1000);

      } catch (error) {
        showStatus('error', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n\nãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        setProgress(0);
        console.error('Conversion error:', error);
      }
    }

    // åˆæœŸåŒ–
    updateVersions();
    setConversionMode('both');
  </script>
</body>
</html>
